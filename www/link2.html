<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <!-- Required meta tags-->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2196f3">
    <title>My App</title>
    <!-- Path to Framework7 Library Bundle CSS -->
    <link rel="stylesheet" href="lib/framework7-bundle.min.css">
    <!-- CSS PERSONALIZADO PARA MENU-->
    <link rel="stylesheet" href="css/index.css">
    <!--Ícones Material Design-->
    <link rel="stylesheet" href="css/materialdesignicons.min.css">
    <link rel="stylesheet" href="css/remix-icons/remixicon.css" />
</head>

<body>
    <div id="app">
        <!-- Your main view, should have "view-main" class -->
        <div class="view view-main">
            <!-- Initial Page, "data-name" contains page name -->
            <div data-name="link2" class="page">
                <div class="top-nav">
                    <h1 class="tittle-logo">Chats</h1>
                </div>

                <form class="form1">
                    <input placeholder="Buscar" type="text" id="buscarInput" />
                    <i class="icone-busca ri-search-2-line"></i>
                </form>

                <!-- Scrollable page content -->
                <div class="page-content">
                    <div class="body-chat" id="listaChats">
                        <!-- A lista de chats será preenchida dinamicamente com JavaScript -->
                    </div>
                </div>
            </div>
            <div id="menuPrincipal" class="toolbar toolbar-bottom">
                <div class="toolbar-inner display-flex">
                    <a onclick="window.location.href= 'index.html'" class="tab-link link">
                        <i class="ri-home-5-line"></i>
                        <span>Início</span>
                    </a>
                    <a onclick="window.location.href= 'link2.html'" class="tab-link link active">
                        <i class="ri-chat-1-line"></i>
                        <span>Chat</span>
                    </a>
                    <a onclick="window.location.href= 'user.html'" class="tab-link link">
                        <i class="ri-user-line"></i>
                        <span>Perfil</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Path to Framework7 Library Bundle JS-->
    <script type="text/javascript" src="lib/framework7-bundle.min.js"></script>
    <!-- jQuery -->
    <script type="text/javascript" src="lib/jquery-3.7.0.min.js"></script>
    <!-- Roteamento do app-->
    <script type="text/javascript" src="js/routes.js"></script>
    <script src="cordova.js"></script>

    <!-- Script para carregar os chats -->
  <<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBk3kzqpBKEyrwHdnC_RgHmd4PDUJOqoEU",
        authDomain: "copinfo-5a0f5.firebaseapp.com",
        projectId: "copinfo-5a0f5",
        storageBucket: "copinfo-5a0f5.appspot.com",
        messagingSenderId: "543026869888",
        appId: "1:543026869888:web:f2ef1ce629b2bf49615865",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function carregarChats() {
        const userData = JSON.parse(localStorage.getItem("userData")); // Recupera os dados do usuário logado
        const usuarioEmail = userData.Email; // Obtém o e-mail do usuário logado

        const emailMudado = localStorage.getItem("emailMudado");
        const usuariosCollection = collection(db, emailMudado);
        const usuariosSnapshot = await getDocs(usuariosCollection);
        const usuariosList = usuariosSnapshot.docs.map(doc => doc.data());

        const listaChats = document.getElementById("listaChats");
        listaChats.innerHTML = "";

        usuariosList.forEach(user => {
            // Verifica se o usuário é o mesmo que o logado comparando os e-mails
            if (user.Email === usuarioEmail) {
                return; // Se o e-mail do contato for igual ao do usuário logado, não adiciona à lista
            }

            const button = document.createElement("a");
            button.classList.add("user1");

            // Adiciona evento de click no botão do chat
            button.onclick = () => {
                // Salva as informações do usuário selecionado no localStorage
                localStorage.setItem("usuarioId", user.id);
                localStorage.setItem("usuarioNome", user.Nome);
                localStorage.setItem("usuarioFoto", user.FotoPerfil); // Salva a URL da foto de perfil
                localStorage.setItem("usuarioEmail", user.Email);

                // Redireciona para a página do chat
                window.location.href = "chat.html";
            };

            button.setAttribute("data-id", user.id);
            button.innerHTML = `
                <div class="icone-user">
                    <img src="${user.FotoPerfil}" class="user-img" alt="Foto de perfil">
                </div>
                <h2 class="nome">${user.Nome}</h2>
            `;

            listaChats.appendChild(button);
        });
    }

    // Função para buscar chats
    function buscarChats() {
        const buscaInput = document.getElementById('buscarInput');
        const buscaTexto = buscaInput.value.toLowerCase();

        const listaChats = document.getElementById('listaChats');
        const usuariosList = Array.from(listaChats.getElementsByClassName('user1'));

        usuariosList.forEach(userElement => {
            const nomeUsuario = userElement.querySelector('.nome').textContent.toLowerCase();
            if (nomeUsuario.includes(buscaTexto)) {
                userElement.style.display = 'block';
            } else {
                userElement.style.display = 'none';
            }
        });
    }

    // Adicionar evento de busca
    document.getElementById('buscarInput').addEventListener('input', buscarChats);

    window.onload = carregarChats;
</script>

</body>

</html>

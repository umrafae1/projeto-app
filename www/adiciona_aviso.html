<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2196f3">
    <title>My App</title>

    <link rel="stylesheet" href="css/remix-icons/remixicon.css" />
    <link rel="stylesheet" href="css/materialdesignicons.min.css">
    <link rel="stylesheet" href="css/adicionar_aviso.css">
    <link rel="stylesheet" href="css/index.css">
</head>

<body>
    <div id="app">
        <div class="view view-main">
            <div data-name="lista_user" class="page">
                <div class="top-nav-add-aviso">
                    <h1 class="tittle-logo"><a onclick="window.location.href = 'opcoes.html'"><i class="ri-arrow-left-s-line"></i></a></h1>
                    <h2 class="top-name-add-aviso">Adicionar Avisos</h2>
                </div>

                <div class="page-content-aviso">
                    <textarea class="texto-aviso" placeholder="Digite aqui..." rows="4"></textarea>

                    <button class="enviar-aviso">Postar</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-analytics.js";
        import { getFirestore, doc, setDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBk3kzqpBKEyrwHdnC_RgHmd4PDUJOqoEU",
            authDomain: "copinfo-5a0f5.firebaseapp.com",
            databaseURL: "https://copinfo-5a0f5-default-rtdb.firebaseio.com",
            projectId: "copinfo-5a0f5",
            storageBucket: "copinfo-5a0f5.appspot.com",
            messagingSenderId: "543026869888",
            appId: "1:543026869888:web:f2ef1ce629b2bf49615865",
            measurementId: "G-9JHXYXYKGT"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        document.querySelector('.enviar-aviso').addEventListener('click', async function() {
            const avisoTexto = document.querySelector('.texto-aviso').value;

            if (avisoTexto.trim() !== '') {
                const userData = JSON.parse(localStorage.getItem("userData"));
                const adminEmail = userData.Email;

                // Substituir os pontos (.) no email por sublinhados (_) para criar um nome válido para a coleção
                const validAdminEmail = adminEmail.replace(/\./g, "_");

                try {
                    const adminDocRef = doc(db, "admins", validAdminEmail);

                    await setDoc(adminDocRef, {
                        email: adminEmail,
                        chat: "Ativo",
                    });

                    // Subcoleção "tela de aviso"
                    const avisosRef = collection(adminDocRef, "tela de aviso");

                    // Adiciona o aviso na subcoleção
                    await addDoc(avisosRef, {
                        texto: avisoTexto,
                        data: new Date().toISOString(),
                    });

                    document.querySelector('.texto-aviso').value = '';

                    window.location.href = 'telaaviso.html';

                } catch (error) {
                    console.error('Erro ao postar aviso:', error);
                    alert('Erro ao postar aviso. Tente novamente.');
                }
            } else {
                alert('Por favor, digite um aviso!');
            }
        });
    </script>
</body>

</html>

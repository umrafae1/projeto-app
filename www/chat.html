<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2196f3">
    <title>Chat</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css">
    <link rel="stylesheet" href="css/chat.css">
</head>
<body>
    <div id="app">
        <div class="view view-main">
            <div data-name="chat" class="page">
                <div class="top-nav__chat">
                    <a class="btn-back" href="link2.html">
                        <i class="ri-arrow-left-s-line"></i>
                    </a>
                    <h2 class="nome_chat" id="nomeChat"></h2>
                    <div class="foto_chat" id="fotoChat"></div>
                </div>

                <div class="page-content">
                    <section class="container__chat">
                        <section class="chat__messages" id="chatMessages"></section>
                        <form class="chat__form" id="chatForm">
                            <input type="text" class="chat__input" placeholder="Digite uma mensagem" required id="messageInput" />
                            <button type="submit" class="chat__button">
                                <i class="ri-send-plane-2-fill icone"></i>
                            </button>
                        </form>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBk3kzqpBKEyrwHdnC_RgHmd4PDUJOqoEU",
            authDomain: "copinfo-5a0f5.firebaseapp.com",
            projectId: "copinfo-5a0f5",
            storageBucket: "copinfo-5a0f5.appspot.com",
            messagingSenderId: "543026869888",
            appId: "1:543026869888:web:f2ef1ce629b2bf49615865",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const usuarioNome = localStorage.getItem("usuarioNome");
        const usuarioFoto = localStorage.getItem("usuarioFoto");

        document.getElementById("nomeChat").textContent = usuarioNome;
        const fotoChat = document.getElementById("fotoChat");
        fotoChat.style.backgroundImage = `url('${usuarioFoto}')`;

        function loadMessages() {
            const chatMessages = document.getElementById("chatMessages");
            const usuarioId = localStorage.getItem("usuarioId");
            const chatRef = collection(db, "chats", usuarioId, "messages");
            const q = query(chatRef, orderBy("timestamp"));

            onSnapshot(q, (querySnapshot) => {
                chatMessages.innerHTML = "";
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const messageElement = document.createElement("div");
                    const timeElement = document.createElement("div");
                    
                    messageElement.textContent = `${data.sender}: ${data.text}`;
                    messageElement.className = data.sender === usuarioNome ? "message message--self" : "message message--other";

                    const timestamp = data.timestamp ? data.timestamp.toDate() : new Date();
                    const hours = timestamp.getHours().toString().padStart(2, '0');
                    const minutes = timestamp.getMinutes().toString().padStart(2, '0');
                    timeElement.textContent = `${hours}:${minutes}`;
                    timeElement.style.fontSize = "0.8rem";
                    timeElement.style.marginTop = "5px";
                    timeElement.style.color = "var(--cinza)";

                    messageElement.appendChild(timeElement);
                    chatMessages.appendChild(messageElement);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }

        document.getElementById("chatForm").addEventListener("submit", async (event) => {
            event.preventDefault();
            const messageInput = document.getElementById("messageInput");
            const messageText = messageInput.value.trim();

            if (messageText === "") return;

            const usuarioId = localStorage.getItem("usuarioId");
            const newMessage = { sender: usuarioNome, text: messageText, timestamp: new Date() };

            await addDoc(collection(db, "chats", usuarioId, "messages"), newMessage);
            messageInput.value = "";
        });

        window.onload = loadMessages;
    </script>
</body>
</html>
